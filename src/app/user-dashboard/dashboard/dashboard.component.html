<app-navbar-user></app-navbar-user>

<div class="app-main-container"> 
  <button mat-icon-button (click)="toggleEditMode()" class="edit-widget-button">
    <mat-icon>{{ isEditMode ? 'close' : 'edit' }}</mat-icon>
  </button>

  <!-- Edit Mode Toolbar -->
  <div *ngIf="isEditMode" class="edit-mode-toolbar">
    <button mat-icon-button [matMenuTriggerFor]="widgetMenu" class="add-widget-button">
      <mat-icon>add</mat-icon>
    </button>
    <button mat-icon-button (click)="deleteSelectedWidgets()" class="delete-widget-button">
      <mat-icon>delete</mat-icon>
    </button>
  
    <mat-menu #widgetMenu="matMenu">
      <button *ngFor="let widget of widgets" mat-menu-item (click)="addWidget(widget.id)">
        {{ widget.nameFr }}
      </button>
    </mat-menu>
  </div>

  <div class="widget-container">
      <!-- Iterate over each createdWidget -->
      <ng-container *ngFor="let widget of createdWidgets">
            <!-- Display based on widgetType -->
            <ng-container *ngIf="widget.widgetDetails?.typewid === 'Liste'">
              <div cdkDrag [cdkDragFreeDragPosition]="widgetPositions[widget.id]" (cdkDragEnded)="onDragEnded($event, widget)">
                <mat-card [style.background-color]="getStyleValue(widget.widStyle, 'backgroundColor')"
                          [style.width]="widget.widWidth" [style.height]="widget.widHeight">
                  <mat-card-header>
                    <mat-card-title [ngStyle]="getTextStyles(widget.widStyle)"> {{ widget.nameFr }}</mat-card-title>
                    <div *ngIf="isEditMode" class="widget-controls">
                      <div class="drag-handle" cdkDragHandle>
                        <mat-checkbox class="widget-checkbox" (change)="toggleWidgetCheck($event.checked, widget.id)"></mat-checkbox>
                        <svg width="24px" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                          <path d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z"></path>
                          <path d="M0 0h24v24H0z" fill="none"></path>
                        </svg>
                      </div>
                    </div>
                  </mat-card-header>
                  <mat-card-content>
                    <table mat-table [dataSource]="getTableDataSource(widget.widStyle)" class="mat-elevation-z8">
                      <ng-container *ngFor="let column of getTableColumns(widget.widStyle)" [matColumnDef]="column.name">
                        <th mat-header-cell *matHeaderCellDef> {{ column.name }} </th>
                        <td mat-cell *matCellDef="let element"> {{ element[column.name] }} </td>
                      </ng-container>
                      <tr mat-header-row *matHeaderRowDef="getTableColumnNames(widget.widStyle)"></tr>
                      <tr mat-row *matRowDef="let row; columns: getTableColumnNames(widget.widStyle)"></tr>
                    </table>
                  </mat-card-content>
                </mat-card>
              </div>
            </ng-container>
            
            
        
        <div *ngIf="widget.widgetDetails?.typewid === 'Indicateur'" [cdkDragFreeDragPosition]="widgetPositions[widget.id]" cdkDrag (cdkDragEnded)="onDragEnded($event, widget)">
          <mat-card [style.background-color]="getStyleValueFromArray(widget.widStyle, 'backgroundColor')"
                    [style.width]="widget.widWidth" [style.height]="widget.widHeight" class="indicator-card">
            <mat-card-header>
              <mat-card-title [ngStyle]="getTextStyles(widget.widStyle)">
                {{ widget.nameFr }}
              </mat-card-title>
              <div *ngIf="isEditMode" class="widget-controls">
                <div class="drag-handle" cdkDragHandle>
                  <mat-checkbox class="widget-checkbox" (change)="toggleWidgetCheck($event.checked, widget.id)"></mat-checkbox>
                  <svg width="24px" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                    <path d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z"></path>
                    <path d="M0 0h24v24H0z" fill="none"></path>
                  </svg>
                  
                </div>
               
              </div>
            </mat-card-header>
            <mat-card-content>
              <div class="value" [ngStyle]="getTextStyles(widget.widStyle)">
                â‚¬ {{ widget.widgetDetails?.desc_fr}}
              </div>
              <!-- Example of additional dynamic content -->
              <div class="percentage" [ngStyle]="getTextStyles(widget.widStyle)">
                Variation en pourcentage
                <span [ngClass]="{
                  'positive': getStyleValueFromArray(widget.widStyle, 'indicatorPercentage') > 0,
                  'negative': getStyleValueFromArray(widget.widStyle, 'indicatorPercentage') < 0
                }">
                  {{ getStyleValueFromArray(widget.widStyle, 'indicatorPercentage') > 0 ? '+' : '' }}
                  {{ getStyleValueFromArray(widget.widStyle, 'indicatorPercentage') }}%
                </span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
        
        <div *ngIf="widget.widgetDetails?.typewid === 'Charte'" cdkDrag [cdkDragFreeDragPosition]="widgetPositions[widget.id]" (cdkDragEnded)="onDragEnded($event, widget)">
          <mat-card [style.background-color]="getStyleValueFromArray(widget.widStyle, 'backgroundColor')"
                    [style.width]="widget.widWidth" [style.height]="widget.widHeight" class="chart-card">
            <mat-card-header>
              <mat-card-title [ngStyle]="getTextStyles(widget.widStyle)">
                {{ widget.nameFr }}
              </mat-card-title>
              <div *ngIf="isEditMode" class="widget-controls">
                <div class="drag-handle" cdkDragHandle>
                  <mat-checkbox class="widget-checkbox" (change)="toggleWidgetCheck($event.checked, widget.id)"></mat-checkbox>
                  <svg width="24px" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                    <path d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z"></path>
                    <path d="M0 0h24v24H0z" fill="none"></path>
                  </svg>
                  
                </div>
                
              </div>
            </mat-card-header>
            <mat-card-content class="chart-container">
              <highcharts-chart
                [Highcharts]="Highcharts"
                [constructorType]="'chart'"
                [options]="getChartOptions(widget)"
                [(update)]="updateFlag"
                [oneToOne]="true"
                [runOutsideAngular]="false"
                style="width: 100%; height: 100%; display: block;">
              </highcharts-chart>
            </mat-card-content>
          </mat-card>
        </div>
        
      </ng-container>
  </div>
    
</div>


